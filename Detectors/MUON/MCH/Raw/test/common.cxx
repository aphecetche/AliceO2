#include "common.h"
#include "MCHRaw/GBTEncoder.h"
#include "MCHRaw/CRUEncoder.h"
#include "MCHRaw/RAWDataHeader.h"
namespace o2
{
namespace mch
{
namespace raw
{
namespace test
{

using ::operator<<;

int countRDHs(gsl::span<uint32_t> buffer)
{
  o2::mch::raw::RAWDataHeader rdh;
  int index{0};
  int nrdh{0};
  while (index < buffer.size()) {
    memcpy(&rdh, &buffer[0] + index, sizeof(rdh));
    nrdh++;
    if (rdh.memorySize == 0) {
      return -1;
    }
    index += rdh.memorySize / 4;
  }
  return nrdh;
}

int showRDHs(gsl::span<uint32_t> buffer)
{
  o2::mch::raw::RAWDataHeader rdh;
  int index{0};
  int nrdh{0};
  while (index < buffer.size()) {
    memcpy(&rdh, &buffer[0] + index, sizeof(rdh));
    nrdh++;
    std::cout << "----- index " << index << "\n";
    std::cout << rdh << "\n";
    if (rdh.memorySize == 0) {
      return -1;
    }
    index += rdh.memorySize / 4;
  }
  return nrdh;
}

void dumpBuffer(gsl::span<uint32_t> buffer)
{
  // dump a buffer, assuming it starts with a RDH
  // return the number of RDHs

  int i{0};
  for (auto& w : buffer) {
    std::cout << fmt::format("{:08X} ", w);
    if ((i + 1) % 4 == 0) {
      std::cout << "\n";
    }
    ++i;
  }
}

std::vector<uint32_t> createCRUBuffer(int cruId)
{
  GBTEncoder::forceNoPhase = true;
  CRUEncoder cru(cruId);

  uint32_t bx(0);
  uint8_t solarId(0);
  uint8_t elinkId(0);
  uint16_t ts(0);

  cru.startHeartbeatFrame(12345, 678);

  cru.addChannelChargeSum(solarId, elinkId, ts, 0, 10);

  cru.startHeartbeatFrame(12345, 910);

  solarId = 1;
  elinkId = 2;
  cru.addChannelChargeSum(solarId, elinkId, ts, 0, 10);
  solarId = 2;
  elinkId = 3;
  cru.addChannelChargeSum(solarId, elinkId, ts, 0, 10);

  solarId = 12;
  elinkId = 3;

  cru.addChannelChargeSum(solarId, elinkId, ts, 3, 13);
  cru.addChannelChargeSum(solarId, elinkId, ts, 13, 133);
  cru.addChannelChargeSum(solarId, elinkId, ts, 23, 163);

  elinkId = 2;

  cru.addChannelChargeSum(solarId, elinkId, ts, 0, 10);
  cru.addChannelChargeSum(solarId, elinkId, ts, 1, 20);
  cru.addChannelChargeSum(solarId, elinkId, ts, 2, 30);
  cru.addChannelChargeSum(solarId, elinkId, ts, 3, 40);

  elinkId = 10;

  cru.addChannelChargeSum(solarId, elinkId, ts, 22, 420);
  cru.addChannelChargeSum(solarId, elinkId, ts, 23, 430);
  cru.addChannelChargeSum(solarId, elinkId, ts, 24, 440);
  cru.addChannelChargeSum(solarId, elinkId, ts, 25, 450);
  cru.addChannelChargeSum(solarId, elinkId, ts, 26, 460);
  cru.addChannelChargeSum(solarId, elinkId, ts, 12, 420);

  std::vector<uint32_t> buffer;
  cru.moveToBuffer(buffer);
  return buffer;
}

ElinkEncoder createElinkEncoder()
{
  ElinkEncoder enc(0, 9);

  enc.addChannelChargeSum(1, 20, 101);
  enc.addChannelChargeSum(5, 100, 505);
  enc.addChannelChargeSum(13, 260, 1313);
  enc.addChannelChargeSum(31, 620, 3131);

  return enc;
}

std::vector<uint32_t> createGBTBuffer()
{
  GBTEncoder::forceNoPhase = true;
  GBTEncoder enc(0, 0);
  uint32_t bx(0);
  uint16_t ts(12);
  int elinkId = 0;
  enc.addChannelChargeSum(elinkId, ts, 0, 10);
  enc.addChannelChargeSum(elinkId, ts, 31, 160);
  elinkId = 3;
  enc.addChannelChargeSum(elinkId, ts, 3, 13);
  enc.addChannelChargeSum(elinkId, ts, 31, 133);
  enc.addChannelChargeSum(elinkId, ts, 13, 163);
  std::vector<uint32_t> words;
  enc.moveToBuffer(words);
  return words;
}

// REF_BUFFER was generated using phase=0 for elinks
std::array<uint32_t, 640> REF_BUFFER = {
  0xFFFFFFFF,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0xFFFFFFFF,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0xFFFFFFFF,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0xFFFFFF3C,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555596,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000041,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0xFFFFFFFC,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0xFFFFFF3C,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x000000C0,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0xFFFFFF7D,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x000000C3,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0xFFFFFF7E,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0xFFFFFFFE,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555596,
  0x55555555,
  0x00005555,
  0x00000000,
  0xFFFFFF3C,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000041,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x000000C0,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x000000C3,
  0x00000000,
  0x00000000,
  0x00000000,
  0x000000C3,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000041,
  0x00000000,
  0x00000000,
  0x00000000,
  0xFFFFFF3C,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0xFFFFFF3C,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555555,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0xFFFFFF3C,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x000000C3,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000040,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000040,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000002,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000082,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0xFFFFFF3C,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0xFFFFFF3C,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555517,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555515,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555595,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555554,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0xFFFFFFFF,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000003,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555554,
  0x55555555,
  0x00005555,
  0x00000000,
  0x000000C0,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0xFFFFFF3D,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0xFFFFFF3D,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555557,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555515,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555515,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x555555D4,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0xFFFFFFFF,
  0xFFFFFFFF,
  0x0000FFFF,
  0x00000000,
  0x00000003,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555594,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000080,
  0x00000000,
  0x00000000,
  0x00000000,
  0x55555514,
  0x55555555,
  0x00005555,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000,
  0x00000001,
  0x00000000,
  0x00000000,
  0x00000000};

} // namespace test
} // namespace raw
} // namespace mch
} // namespace o2
